<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do List</title>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

    <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
        apiKey: "AIzaSyDFFKVSC31CZyeKkOmqNP0uZiJ_XVo-d3o",
        authDomain: "harper-fb1.firebaseapp.com",
        databaseURL: "https://harper-fb1.firebaseio.com",
        projectId: "harper-fb1",
        storageBucket: "harper-fb1.appspot.com",
        messagingSenderId: "1054303864379",
        appId: "1:1054303864379:web:203b783fb5132b55a73e1e",
        measurementId: "G-H7NXGJP8GC"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const DB=firebase.firestore();
    </script>
</head>
<style>
    .list{
        background-color:rgb(175, 196, 240);
        width:600px;
        padding:10px;
        padding-left:20px;
        padding-right:20px;
    }
    #tasks{
        height:500px;
    }
    .task{
        display:grid;
        gap:5px;
        grid-template-columns:100px 100px 100px 100px;
        grid-template-rows:20px;
        margin:40px;
    }
    .info{
        padding:5px;
    }

    #userMessage{
        font-weight:bolder;
        font-size:20px;
    }
    #doneButton{
        border:1px black solid;
        width:fit-content;
        height:fit-content;
    }
    #deleteButton{
        border:1px black solid;
        width:fit-content;
        height:fit-content;
    }
</style>
<body>
    <div class="list">
        <div id="usernameDiv">
            <form id="submitUser">
                <p>Enter your username: <input type="text" id="username"/><input type="submit" value="Submit"/></p>
            </form>
        </div>
        <div id="tasks">
            <!--write tasks here from DB to DOM-->
        </div>
        <form id="submitTask">
            <p><input type="text" id="taskSubmited" placeholder="Enter task to do"/><input type="submit" value="Submit"/></p>
        </form>
    </div>

    <script>
        //getting and storing username
        const submitUser=document.getElementById("submitUser");
        let username="";
        submitUser.addEventListener('submit', e=>{
            e.preventDefault();
            username=document.getElementById('username').value;
            let usernameDiv=document.getElementById('usernameDiv');
            usernameDiv.innerHTML=`<p id="userMessage">${username}, what do you need to do?</p>`;
        })

        //submits the task and adds to the DB
        const submitTask=document.getElementById('submitTask');
        submitTask.addEventListener('submit', e=>{
            e.preventDefault();
            let task=document.getElementById('taskSubmited').value;
            DB.collection('ToDo').add({task:task, done:false, deleted:false, username:username, added:false});
            submitTask.reset();
        })

        /*
        let doneButtons=document.querySelectorAll('doneButton');
        for(let button of doneButtons){
            console.dir("button:", button);
            button.addEventListener('click',e=>{

            })
        }*/

        DB.collection("ToDo").onSnapshot(tasksDB=>{
            tasksDB.forEach(taskDB=>{
                let id=taskDB.id;
                console.log(id);//test
                if(taskDB.data().added==false){
                    addTask(id);
                    DB.collection("ToDo").doc(`${id}`).update({added:true});
                }
                updateEverything(id);
            })
        })

        //updateEverything
        function updateEverything(id){
            updateName(id);
            updateDone(id);
            updateDelete(id);
            updateUser(id);
        }

        //add Task to the DOM
        function addTask(id){
            let taskDiv=document.getElementById('tasks');
            taskDiv.innerHTML+=`<div id="${id}" class="task">
            <div class="info" id="taskName"></div>
            <div class="info" id="doneButton"></div>
            <div class="info" id="deleteButton"></div>
            <div class="info" id="displayUser"></div>
            </div>`;
            document.getElementById(`${id}`).children[1].addEventListener('click',e=>{
                DB.collection("ToDo").doc(`${id}`).update({done:true});
            })
            document.getElementById(`${id}`).children[2].addEventListener('click',e=>{
                DB.collection("ToDo").doc(`${id}`).update({deleted:true});
            })

        }

        //updateTaskName to DOM
        function updateName(id){
            DB.collection("ToDo").doc(`${id}`).get().then(taskDB=>{
                let name=taskDB.data().task;
                console.log(name);
                document.getElementById(`${id}`).children[0].innerHTML= `<p>${name}</p>`
            })
        }

        //updateDone to DOM
        function updateDone(id){
            DB.collection("ToDo").doc(`${id}`).get().then(taskDB=>{
                let done=taskDB.data().done;
                if(done==false){
                    document.getElementById(`${id}`).children[1].innerHTML= `<p>Incomplete</p>`;
                }
                else{
                    document.getElementById(`${id}`).children[1].innerHTML= `<p>Complete</p>`;
                }
            })
        }

        //updateDelete to DOM
        function updateDelete(id){
            DB.collection("ToDo").doc(`${id}`).get().then(taskDB=>{
                let deleted=taskDB.data().deleted;
                if(deleted==false){
                    document.getElementById(`${id}`).children[2].innerHTML= `<p>Delete</p>`;
                }
                else{
                    document.getElementById(id).style.display="none";
                    document.getElementById(`${id}`).children[2].innerHTML= `<p>Deleted</p>`;
                }
            })
        }

        //updateUser to DOM
        function updateUser(id){
            DB.collection("ToDo").doc(`${id}`).get().then(taskDB=>{
                let user=taskDB.data().username;
                document.getElementById(`${id}`).children[3].innerHTML=`<p>${user}</p>`;
            })
        }


    </script>
</body>
</html>